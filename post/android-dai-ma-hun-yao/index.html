<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>【Android】代码混淆 | 紫豪的Blog</title>
<meta name="description" content="You cannot improve your past, but you can improve your future. Once time is wasted, life is wasted.">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="https://iflytek-duan.github.io//favicon.ico?v=1601280524333">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/papercss@1.6.1/dist/paper.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://iflytek-duan.github.io//styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  

<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />


  </head>
  <body>
  
    <nav class="navbar border fixed split-nav">
  <div class="nav-brand">
    <h3><a href="https://iflytek-duan.github.io/">紫豪的Blog</a></h3>
  </div>
  <div class="collapsible">
    <input id="collapsible1" type="checkbox" name="collapsible1">
    <button>
      <label for="collapsible1">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </label>
    </button>
    <div class="collapsible-body">
      <ul class="inline">
        
          <li>
            
              <a href="https://iflytek-duan.github.io/" class="menu">
                首页
              </a>
            
          </li>
        
          <li>
            
              <a href="/archives" class="menu">
                归档
              </a>
            
          </li>
        
          <li>
            
              <a href="/tags" class="menu">
                标签
              </a>
            
          </li>
        
          <li>
            
              <a href="/post/about" class="menu">
                关于
              </a>
            
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div id="top" class="row site">
      <div class="sm-12 md-8 col">
        <div class="paper">
          <article class="article">
            <h1>【Android】代码混淆</h1>
            <p class="article-meta">
              2020-07-01
              
                <a href="https://iflytek-duan.github.io/tag/rbK2TBn2R/" class="badge secondary">
                  混淆
                </a>
              
                <a href="https://iflytek-duan.github.io/tag/SrlbRb6sn/" class="badge success">
                  Android
                </a>
              
            </p>
            
              <img src="https://iflytek-duan.github.io//post-images/android-dai-ma-hun-yao.jpeg" alt="【Android】代码混淆">
            
            <div class="post-content">
              <h1 id="一-app混淆配置">一、App混淆配置</h1>
<p><strong>1. 基础的指令配置</strong></p>
<pre><code class="language-java">-optimizationpasses 5 # 指定代码的压缩级别
-dontusemixedcaseclassnames # 混淆后类名都为小写
-dontskipnonpubliclibraryclasses #指定不去忽略非公共的库的类
-dontskipnonpubliclibraryclassmembers #指定不去忽略非公共的库的类的成员
-dontpreverify # 不做预校验的操作
-verbose # 混淆时是否记录日志
-printmapping proguardMapping.txt #生成原类名和混淆后的类名的映射文件
-optimizations !code/simplification/arithmetic,!field/*,!class/merging/*  # 混淆时所采用的算法
-keepattributes *Annotation*,InnerClasses #不混淆Annotation
-keepattributes Signature #不混淆泛型
-keepattributes SourceFile,LineNumberTable #抛出异常时保留代码行号
-ignorewarnings #抑制警告
</code></pre>
<p><strong>2. 一些通用的必要配置</strong></p>
<pre><code class="language-java">#系统类不需要混淆
-keep public class * extends android.app.Activity
-keep public class * extends android.app.Application
-keep public class * extends android.app.Service
-keep public class * extends android.content.BroadcastReceiver
-keep public class * extends android.content.ContentProvider
-keep public class * extends android.app.backup.BackupAgentHelper
-keep public class * extends android.preference.Preference
-keep public class * extends android.view.View
-keep public class com.android.vending.licensing.ILicensingS
-keep class android.support.** {*;}
-keep public class * extends android.app.Fragment

-keepclasseswithmembernames class * {  # 保持 native 方法不被混淆
    native &lt;methods&gt;;
}
-keepclassmembers class * extends android.app.Activity { # 保持自定义控件类不被混淆
    public void *(android.view.View);
}
-keepclassmembers enum * {# 保持枚举 enum 类不被混淆
    public static **[] values();
    public static ** valueOf(java.lang.String);
}
-keep public class * extends android.view.View{# 保持View类不被混淆
    *** get*();
    void set*(***);
    public &lt;init&gt;(android.content.Context);
    public &lt;init&gt;(android.content.Context, android.util.AttributeSet);
    public &lt;init&gt;(android.content.Context, android.util.AttributeSet, int);
}
-keepclasseswithmembers class * {# 保持自定义控件类不被混淆
    public &lt;init&gt;(android.content.Context, android.util.AttributeSet);
    public &lt;init&gt;(android.content.Context, android.util.AttributeSet, int);
}
-keep class * implements android.os.Parcelable { # 保持 Parcelable 不被混淆
    public static final android.os.Parcelable$Creator *;
}
-keepclassmembers class * implements java.io.Serializable {
    static final long serialVersionUID;
    private static final java.io.ObjectStreamField[] serialPersistentFields;
    private void writeObject(java.io.ObjectOutputStream);
    private void readObject(java.io.ObjectInputStream);
    java.lang.Object writeReplace();
    java.lang.Object readResolve();
}
-keep class **.R$* {
 *;
}
-keepclassmembers class * {
    void *(**On*Event);
}

#WebView相关
-keepclassmembers class fqcn.of.javascript.interface.for.Webview {
   public *;
}
-keepclassmembers class * extends android.webkit.WebViewClient {
    public void *(android.webkit.WebView, java.lang.String, android.graphics.Bitmap);
    public boolean *(android.webkit.WebView, java.lang.String);
}
-keepclassmembers class * extends android.webkit.WebViewClient {
    public void *(android.webkit.WebView, java.lang.String);
}

# 其它
-keep class com.google.android.gms.** {*;}
-dontwarn com.google.android.gms.**
-dontwarn com.viewpagerindicator.*
-dontwarn com.amazonaws.**
-dontnote com.google.vending.licensing.ILicensingService
-dontnote com.android.vending.licensing.ILicensingService


# Androidx相关
-keep class com.google.android.material.** {*;}
-keep class androidx.** {*;}
-keep public class * extends androidx.**
-keep interface androidx.** {*;}
-dontwarn com.google.android.material.**
-dontnote com.google.android.material.**
-dontwarn androidx.**
</code></pre>
<p><strong>3. 实体类</strong></p>
<pre><code class="language-java"># 可能会存在多处，需要一一添加
-keep class 包名.bean.** {*;}
</code></pre>
<p><strong>4. 第三方Library</strong></p>
<pre><code class="language-java"># 本地.so库文件声明
-libraryjars libs/armeabi/xxx.so
-libraryjars libs/armeabi-v7/xxx.so
-libraryjars libs/x86/xxx.so

# 常用第三方Library混淆配置
# Glide
-keep public class * implements com.bumptech.glide.module.GlideModule
-keep public class * extends com.bumptech.glide.module.AppGlideModule
-keep public enum com.bumptech.glide.load.resource.bitmap.ImageHeaderParser$** {
  **[] $VALUES;
  public *;
}

# Alipay
-dontwarn com.alipay.**
-dontwarn com.ta.utdid2.**
-dontwarn com.ut.device.**
-dontwarn android.net.**
-keep class com.alipay.** {*;}
-keep class com.ta.utdid2.** {*;}
-keep class com.ut.device.** {*;}
-keep class android.net.SSLCertificateSocketFactory

# butterknife
-keep class butterknife.** {*;}
-dontwarn butterknife.internal.**
-keep class **$$ViewBinder {*;}
-keepclasseswithmembernames class * {
    @butterknife.* &lt;fields&gt;;
}
-keepclasseswithmembernames class * {
    @butterknife.* &lt;methods&gt;;
}

# eventbus
-keepattributes *Annotation*
-keepclassmembers class ** {
    @com.google.common.eventbus.Subscribe &lt;methods&gt;;
        public void onEvent*(**);
        void onEvent*(**);
}
-keep enum de.greenrobot.event.ThreadMode {*;}
-keepclassmembers class * extends de.greenrobot.event.util.ThrowableFailureEvent {
    &lt;init&gt;(java.lang.Throwable);
}

# Gson
-dontwarn com.google.gson.**
-keep class com.google.gson.** {*;}
-keep class sun.misc.Unsafe {*;}

# 科大讯飞相关(ifly_push_sdk &amp;&amp; Msc)
-dontwarn com.iflytek.**
-keep class com.iflytek.** {*;}

# 腾讯相关(libammsdk &amp;&amp; open_sdk)
-dontwarn com.tencent.**
-keep class com.tencent.** {*;}

# weibosdkcore
-dontwarn com.sina.weibo.sdk.**
-keep class com.sina.weibo.sdk.** {*;}

# Dagger
-dontwarn dagger.internal.codegen.**
-dontwarn javax.inject.**
-keepclassmembers,allowobfuscation class * {
    @javax.inject.* *;
    @dagger.* *;
    &lt;init&gt;();
}
-keep class dagger.** {*;}
-keep class javax.inject.** {*;}
-keep class * extends dagger.internal.Binding
-keep class * extends dagger.internal.ModuleAdapter
-keep class * extends dagger.internal.StaticInjection

</code></pre>
<blockquote>
<p>这里要注意的一点是，要避免重复声明jar包——如果在build.gradle中使用了<code>compile fileTree(include: ['*.jar'], dir: 'libs')</code>，就不需要在混淆文件中添加<code>-libraryjars libs/xxx.jar</code>去声明对应的jar了，否则会报错提示重复添加。</p>
</blockquote>
<p><strong>5. 反射类及其相关方法</strong></p>
<pre><code class="language-java">-keep class java.lang.annotation.** {*;}
</code></pre>
<p><strong>6. JS相关交互类(方法互调)</strong></p>
<pre><code class="language-java"></code></pre>
<hr>
<h1 id="二-moduleaar-lib混淆配置">二、Module（aar、lib)混淆配置</h1>
<blockquote>
<p>我们在封装<code>aar、lib</code>提供给他人使用时，为了保证功能能够正常的被使用，往往需要告知别人针对<code>aar、lib</code>进行免混淆配置以保证<code>aar、lib</code>中的一些关键类不被混淆以免影响正常使用。（github上很多Library的README.md文件中都有对应的混淆清单提示）<br>
但是在实际的使用过程中，经常有用户会忘记在<code>App</code>中进行对应的<code>aar、lib</code>的免混淆配置，导致其功能不能正常使用（打包后关键类被混淆），这样的的操作是很不友好的。</p>
</blockquote>
<p><strong>AndroidStudio</strong>在3.x之后，其实已经为我们提供了新的解决办法，在新建<code>Module</code>后，我们会发现<code>Module</code>下有了<code>proguard-rules.pro</code>、<code>consumer-rules.pro</code>两个文件，而在<code>Module/build.gradle</code>配置文件的<code>defaultConfig</code>中，我们会发现有个<code>consumerProguardFiles</code>配置，它其实就是为了解决<code>aar、lib</code>混淆配置后<code>App</code>没有进行对应的配置导致<code>aar、lib</code>的配置未生效的问题。</p>
<p><strong>正确的解决方案（只需在aar、lib中进行对应的混淆配置，即便引用的App在混淆时不针对aar、lib进行对应的配置，打包后也不会影响aar、lib的正确混淆）：</strong><br>
在<code>Module/build.gradle</code>中配置（Android 3.x后会默认生成该配置）：</p>
<pre><code class="language-java">android {
    defaultConfig {
        consumerProguardFiles 'consumer-rules.pro'
    }
}
</code></pre>
<p>然后在在<code>Module/consumer-rules.pro</code>文件中进行具体的混淆配置。</p>
<hr>
<h1 id="拓展阅读">拓展阅读</h1>
<p><a href="http://blog.csdn.net/hudan2714/article/details/53191782">整理Android最全的混淆规则大全（最新的开源框架混淆）</a><br>
<a href="http://blog.csdn.net/qq_15807167/article/details/52683375">Android混淆</a><br>
<a href="https://blog.csdn.net/lhd201006/article/details/72913071">Android Studio的Proguard（代码混淆）</a><br>
<a href="https://www.v2ex.com/t/646787">Android 配置中的 consumerProguardFiles</a></p>

            </div>
          </article>
        </div>
        <div class="paper" data-aos="fade-in">
          
            <div class="next-post">
              <div class="next">
                下一篇
              </div>
              <a href="https://iflytek-duan.github.io/post/kotlin-si-ji-he-kuang-jia/">
                <h3 class="post-title">
                  【Kotlin】（四）集合框架
                </h3>
              </a>
            </div>
          
        </div>
        
          
            <div class="paper" data-aos="fade-in">
              <div id="gitalk-container"></div>
            </div>
          

          
        
      </div>

      <div class="sm-12 md-4 col sidebar">
  <div class="paper info-container">
    <img src="https://iflytek-duan.github.io//images/avatar.png?v=1601280524333" class="no-responsive avatar">
    <div class="text-muted">You cannot improve your past, but you can improve your future. Once time is wasted, life is wasted.</div>
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      最新文章
    </div>
    <div class="row">
      <ul>
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/error-android-da-bao-debug-ban-ben-apk-hou-wu-fa-zheng-chang-an-zhuang/">【Error】Android打包debug版本apk后无法正常安装</a>
            </li>
          
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/android-ble-zhuang-tai-ma-status-codecan-zhao-biao/">【Android】BLE状态码（status code）参照表</a>
            </li>
          
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/android-zi-dong-hua-da-bao/">【Android】自动化打包</a>
            </li>
          
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/kotlin-qi-kuo-zhan-fang-fa/">【Kotlin】（七）扩展方法</a>
            </li>
          
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/kotlin-lei-he-jie-kou/">【Kotlin】（六）类和接口</a>
            </li>
          
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/kotlin-wu-han-shu/">【Kotlin】（五）函数</a>
            </li>
          
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/android-dai-ma-hun-yao/">【Android】代码混淆</a>
            </li>
          
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/kotlin-si-ji-he-kuang-jia/">【Kotlin】（四）集合框架</a>
            </li>
          
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/android-gradle-zhi-duo-lei-xing-pei-zhi/">【Android】Gradle之多类型、类型包名后缀、源集（对应文件资源）配置</a>
            </li>
          
        
          
            <li>
              <a href="https://iflytek-duan.github.io/post/kotlinsan-qu-jian-range/">【Kotlin】（三）区间 Range</a>
            </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      标签列表
    </div>
    <div class="row">
      
        <a href="https://iflytek-duan.github.io/tag/xBD1vC1ZR/" class="badge warning">
          BLE
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/RBqYMVU6r/" class="badge success">
          自动构建
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/MnJlUZFkz/" class="badge secondary">
          Gradle
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/fvbltJpq3/" class="badge secondary">
          kotlin
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/rbK2TBn2R/" class="badge success">
          混淆
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/SrlbRb6sn/" class="badge warning">
          Android
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/IkHQqVGps/" class="badge secondary">
          AndroidStudio
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/VHTsaHEisi/" class="badge ">
          xml
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/eKjFPL3wT/" class="badge success">
          开发规范
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/G39dHKlfB/" class="badge success">
          团队合作
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/myRGoPdmt1/" class="badge success">
          朱赟
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/LodA5mW-B/" class="badge ">
          Retrofit
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/0vRPOTWyAc/" class="badge secondary">
          RxJava
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/Nsy7D59UuD/" class="badge success">
          多状态布局
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/9raW-gICI/" class="badge secondary">
          学习笔记
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/OWd7tNkDZ/" class="badge warning">
          职场规划
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/bLB_9Gt76/" class="badge warning">
          管理
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/tAva3e61N/" class="badge ">
          移动支付
        </a>
      
        <a href="https://iflytek-duan.github.io/tag/efZ6XuM_Fy/" class="badge warning">
          数据库
        </a>
      
    </div>
  </div>
  <div class="paper">
    Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://iflytek-duan.github.io//atom.xml" target="_blank">RSS</a>
  </div>
</div>


    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: 'cae2b8f6a4ade000f9d7',
        clientSecret: '2d3862d6cd21351bfb3e50fd5a51880756c4b684',
        repo: 'iflytek-duan.github.io',
        owner: 'iflytek-duan',
        admin: ['iflytek-duan'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
